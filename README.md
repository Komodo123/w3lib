# w3lib - Warcraft III Tools Library

## Table of Contents

- [Installation](#installation)
- [Replay Parser](#replay-parser)
- [Replay Object](#replay-object)

## Installation

This library can be included using Composer (PHP's package manager). Since this project is still being developed, it is not yet available on packagist. However, it can still be included by adding the following to your `composer.json` file:

```
"repositories": [
	{
		"url": "https://github.com/komodo123/w3lib.git",
		"type": "git"
	}
],
"require": {
	...
	"anders/w3lib": "dev-master",
	...
}
```

## Replay Parser

The replay parser implements quite nearly the full Warcraft III replay file specification for patches >= 1.28 including W3MMD. 

Here is a simple example to print out the names of all players and their APM:

```
<?php

use w3lib\w3g\Replay;
use w3lib\w3g\Lang;
use w3lib\w3g\Settings;

$settings = new Settings ();

/** 
 * Replays usually will have thousands of actions. Storing each action and
 * its parsed components is quite memory intensive. Note that even when
 * this is set to off, actions will still be parsed to calculate player APM,
 * however, they will not be stored in the player models. 
 */
$settings->keepActions = false;

/** 
  * Actions per X configures the size of each action counter window in
  * seconds. For example, a value of 60 indicates that actions counts will be
  * split into buckets of size 60 seconds (apm). 
  */
$settings->apx = 60;

$replay = new Replay ('LastReplay.w3g', $settings);

foreach ($replay->getTeams () as $team) {
	foreach ($team->getPlayers () as $player) {
		printf ('[%s] %d' . PHP_EOL, $player->name, $player->apm);
	}
}

?>
```

To help with statistics generation, the parser looks for a few select W3MMD values to help further structure the data:

* Teams are normally generated using the values defined by the map (the same as they appear in the lobby) *unless* they are overriden with W3MMD (by the sending a value identified by 'team'). This allows maps with dynamic diplomacy (-ally or -war commands) to ensure teams are accurate.

* Score and placement are also special values that are populated from W3MMD if they are available. If only the score is set, teams are sorted by the average score of each player on the team and the placement is automatically generated after sorting. If the placement is also set in W3MMD, it will be used instead of the autogenerated values from sorting by score. If the W3MMD win flag is set for at least one player on a team, that team is considered the winner and will be placed first regardless of score or placement.

## Replay Object

Here is the JSON representation of all of the data that is available in the replay object for a Battleships Crossfire game. A few notes:

* The `_class` annotations correspond to the actual container model used, some of which have useful utility methods. 

* Variables in the player model are parsed from W3MMD.

* The activity array in the players model is simply a count of the number of actions per the APX value defined in settings. If `$settings->apx = 60` then each number is a count of the number of actions per 60 seconds of game time.

```
"header": {
      "intro": "Warcraft III recorded game",
      "headerSize": 68,
      "compressedSize": 743918,
      "headerVersion": 1,
      "uncompressedSize": 2957119,
      "numBlocks": 361,
      "identification": "PX3W",
      "majorVersion": 30,
      "buildVersion": 6061,
      "flags": 32768,
      "length": 4745,
      "checksum": 35026590,
      "_class": "w3lib\\w3g\\Model\\Header"
    },
    "game": {
      "name": "[ENT] BattleShip Crossfire #18",
      "speed": 2,
      "visibility": 3,
      "observers": 0,
      "teamsTogether": true,
      "lockedTeams": true,
      "fullShare": false,
      "randomHero": false,
      "randomRaces": false,
      "checksum": 1189054958,
      "map": "Battleships Crossfire4.70.w3x",
      "host": "GHost++",
      "numSlots": 12,
      "type": 1,
      "private": true,
      "recordId": 25,
      "recordLength": 115,
      "slotRecords": 12,
      "teams": [
        {
          "id": 0,
          "players": [
            {
              "type": 0,
              "id": 2,
              "name": "fiberoptik",
              "race": 4,
              "isHost": true,
              "slot": 2,
              "colour": 2,
              "handicap": 100,
              "leftAt": 4771,
              "isWinner": false,
              "team": 0,
              "score": null,
              "placement": null,
              "activity": [
                52,
                63,
               ...
              ],
              "apm": 85,
              "variables": {
                "goldgathered": "61930",
                "lumbergathered": "0",
                "shiplist": "custom_H041,custom_H02D",
                "deaths": "9",
                "assists": "8",
                "kickcounter": "0",
                "kills": "2",
                "bounty": "9927",
                "creepkills": "990",
                "dodosfound": "0",
                "chatcounter": "2",
                "bountyfeed": "-12222"
              },
              "_class": "w3lib\\w3g\\Model\\Player"
            },
            {
              "type": 22,
              "id": 6,
              "name": "Neoauto",
              "race": 4,
              "isHost": false,
              "slot": 4,
              "colour": 4,
              "handicap": 100,
              "leftAt": 4759,
              "isWinner": false,
              "team": 0,
              "score": null,
              "placement": null,
              "activity": [
                38,
                137,
                ...
              ],
              "apm": 103,
              "variables": {
                "kills": "6",
                "kickcounter": "0",
                "bounty": "10263",
                "bountyfeed": "-14257",
                "goldgathered": "55955",
                "lumbergathered": "0",
                "dodosfound": "0",
                "deaths": "8",
                "creepkills": "418",
                "assists": "6",
                "chatcounter": "515",
                "shiplist": "custom_H01C,custom_H00J,custom_H000,custom_H03O"
              },
              "_class": "w3lib\\w3g\\Model\\Player"
            },
            {
              "type": 22,
              "id": 3,
              "name": "chrismokvack",
              "race": 4,
              "isHost": false,
              "slot": 3,
              "colour": 3,
              "handicap": 100,
              "leftAt": 4759,
              "isWinner": null,
              "team": 0,
              "score": null,
              "placement": null,
              "activity": [
                115,
                139,
                ...
              ],
              "apm": 69,
              "variables": null,
              "_class": "w3lib\\w3g\\Model\\Player"
            },
            {
              "type": 22,
              "id": 8,
              "name": "Kapuster",
              "race": 4,
              "isHost": false,
              "slot": 5,
              "colour": 5,
              "handicap": 100,
              "leftAt": 4759,
              "isWinner": null,
              "team": 0,
              "score": null,
              "placement": null,
              "activity": [
                61,
                90,
                ...
              ],
              "apm": 100,
              "variables": {
                "deaths": "9",
                "assists": "0",
                "dodosfound": "0",
                "bounty": "5886",
                "bountyfeed": "-24022",
                "shiplist": "custom_H013,custom_H000,custom_H02A",
                "creepkills": "452",
                "kills": "5",
                "kickcounter": "0",
                "goldgathered": "45046",
                "lumbergathered": "0",
                "chatcounter": "353"
              },
              "_class": "w3lib\\w3g\\Model\\Player"
            }
          ],
          "score": 0,
          "placement": null,
          "isWinner": false,
          "_class": "w3lib\\w3g\\Util\\Team"
        },
        {
          "id": 1,
          "players": [
            {
              "type": 22,
              "id": 4,
              "name": "TeoNanks",
              "race": 4,
              "isHost": false,
              "slot": 9,
              "colour": 9,
              "handicap": 100,
              "leftAt": 4766,
              "isWinner": true,
              "team": 1,
              "score": null,
              "placement": null,
              "activity": [
                64,
                92,
                ...
              ],
              "apm": 152,
              "variables": {
                "kills": "10",
                "assists": "11",
                "chatcounter": "136",
                "creepkills": "562",
                "dodosfound": "0",
                "kickcounter": "0",
                "bounty": "23111",
                "bountyfeed": "-1922"
              },
              "_class": "w3lib\\w3g\\Model\\Player"
            },
            {
              "type": 22,
              "id": 5,
              "name": "Osama_Hussein",
              "race": 4,
              "isHost": false,
              "slot": 8,
              "colour": 8,
              "handicap": 100,
              "leftAt": 4761,
              "isWinner": null,
              "team": 1,
              "score": null,
              "placement": null,
              "activity": [
                54,
                58,
                ...
              ],
              "apm": 69,
              "variables": [],
              "_class": "w3lib\\w3g\\Model\\Player"
            },
            {
              "type": 22,
              "id": 7,
              "name": "Qrtz",
              "race": 4,
              "isHost": false,
              "slot": 6,
              "colour": 6,
              "handicap": 100,
              "leftAt": 4767,
              "isWinner": true,
              "team": 1,
              "score": null,
              "placement": null,
              "activity": [
                39,
                73,
                ...
              ],
              "apm": 85,
              "variables": {
                "kills": "1",
                "bounty": "4793",
                "bountyfeed": "-1299",
                "assists": "4",
                "kickcounter": "0",
                "lumbergathered": "0",
                "chatcounter": "109",
                "deaths": "2",
                "dodosfound": "0",
                "creepkills": "296",
                "goldgathered": "47515",
                "shiplist": "custom_H02G,custom_H04I"
              },
              "_class": "w3lib\\w3g\\Model\\Player"
            },
            {
              "type": 22,
              "id": 9,
              "name": "dyn",
              "race": 4,
              "isHost": false,
              "slot": 7,
              "colour": 7,
              "handicap": 100,
              "leftAt": 4766,
              "isWinner": true,
              "team": 1,
              "score": null,
              "placement": null,
              "activity": [
                178,
                221,
                ...
              ],
              "apm": 146,
              "variables": {
                "chatcounter": "295",
                "bounty": "30827",
                "creepkills": "814",
                "assists": "18",
                "lumbergathered": "0",
                "kickcounter": "0",
                "bountyfeed": "-8466",
                "shiplist": "custom_H00A",
                "deaths": "4",
                "kills": "10",
                "goldgathered": "84072",
                "dodosfound": "0"
              },
              "_class": "w3lib\\w3g\\Model\\Player"
            }
          ],
          "score": 0,
          "placement": null,
          "isWinner": true,
          "_class": "w3lib\\w3g\\Util\\Team"
        }
      ],
      "randomSeed": 2359613021,
      "selectMode": 3,
      "startSpots": 12,
      "saver": 2,
      "w3mmd": true,
      "_class": "w3lib\\w3g\\Model\\Game"
    },
    "chatlog": {
      "0": {
        "playerId": 2,
        "length": 53,
        "flags": 32,
        "mode": 0,
        "message": "Votestart expired (sixty seconds without pass).",
        "time": 0,
        "_class": "w3lib\\w3g\\Model\\ChatMessage"
      },
      "1": {
        "playerId": 2,
        "length": 55,
        "flags": 32,
        "mode": 0,
        "message": "Shortest load by player [Qrtz] was 22.21 seconds.",
        "time": 0,
        "_class": "w3lib\\w3g\\Model\\ChatMessage"
      },
    ...
    },
    "_class": "w3lib\\w3g\\Replay"
}
```

For questions, bugs, and suggestions feel free to contact me on Discord at Anders#6119!
